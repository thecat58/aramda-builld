document.addEventListener("DOMContentLoaded",function(){const l=document.getElementById("plan");if(!l)return;function c(s){const o=document.querySelectorAll("#registeredPlansList li span");return Array.from(o).map(e=>e.textContent).includes(s)}l.addEventListener("change",function(){if(this.selectedIndex>0){const s=this.options[this.selectedIndex].text,o=this.options[this.selectedIndex].value;if(console.log("Plan seleccionado:",s,"ID:",o),c(s)){const r=`
          <div class="alert alert-warning alert-dismissible fade show" role="alert">
            El plan "${s}" ya ha sido agregado
          </div>
        `,e=document.createElement("div");e.innerHTML=r,l.parentNode.insertBefore(e,l.nextSibling),setTimeout(()=>{e.remove()},3e3)}else{const r=document.getElementById("registeredPlansList"),e=document.createElement("li");e.className="list-group-item d-flex justify-content-between align-items-center",e.dataset.planId=o,console.log("Guardando plan ID:",o);const a=document.createElement("span");a.textContent=s,e.appendChild(a);const t=document.createElement("div");t.className="btn-group";const n=document.createElement("button");n.textContent="Eliminar",n.className="btn btn-danger btn-sm",n.addEventListener("click",function(){r.removeChild(e)}),t.appendChild(n),e.appendChild(t),r.appendChild(e)}this.selectedIndex=0}});const i=document.getElementById("precontractualForm");i&&i.addEventListener("submit",function(s){s.preventDefault();const o=document.querySelectorAll("#registeredPlansList li");if(console.log("Planes encontrados:",o.length),o.length===0){Swal.fire({title:"Error",text:"Debe agregar al menos un plan a la lista",icon:"error"});return}const r=document.getElementById("estudioPrevio").files[0];if(!r){Swal.fire({title:"Error",text:"Debe seleccionar un documento de estudio previo",icon:"error"});return}const e=new FormData;e.append("estudioPrevio",r),e.append("estadoEstudio",document.getElementById("estadoEstudio").value),o.forEach(t=>{const n=t.dataset.planId;console.log("Agregando plan ID:",n),n&&e.append("planes[]",n)});for(let t of e.entries())console.log(t[0]+": "+t[1]);const a=document.querySelector('meta[name="csrf-token"]').getAttribute("content");fetch("/precontractual",{method:"POST",body:e,headers:{"X-CSRF-TOKEN":a,Accept:"application/json"},credentials:"same-origin"}).then(t=>(console.log("Status:",t.status),t.json().then(n=>{if(console.log("Respuesta del servidor:",n),!t.ok)throw new Error(n.message||"Error en la respuesta del servidor");return n}))).then(t=>{t.success&&Swal.fire({title:"Éxito",text:t.message,icon:"success"}).then(()=>{window.location.reload()})}).catch(t=>{console.error("Error completo:",t),Swal.fire({title:"Error",text:t.message||"Ocurrió un error al procesar la solicitud",icon:"error"})})})});
